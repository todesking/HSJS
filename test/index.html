<!DOCTYPE html>
<html>
<head>
	<title>QUnit Test Suite</title>

	<!-- QUnit -->
	<link rel="stylesheet" href="../vendor/qunit/qunit/qunit.css" type="text/css" media="screen">
	<script type="text/javascript" src="../vendor/qunit/qunit/qunit.js"></script>

	<script type="text/javascript" src="./jquery-1.4.2.min.js"></script>

	<!-- Test helpers -->
	<script type="text/javascript" src="./test_helper.js"></script>

	<!-- Test targets -->
	<script type="text/javascript" src="../src/s_parser.js"></script>
	<script type="text/javascript" src="./s_parser_test.js"></script>

	<script type="text/javascript" src="../src/hs.js"></script>
	<script type="text/javascript" src="./hs_test.js"></script>

	<script type="text/hsjs-test" src="hs_test_data.txt"></script>
	<script type="text/javascript">
		(function(){
			var base_module_name='HS high-level test';
			module(base_module_name);
			function register_test(test_name,test_expressions) {
				test(test_name,function() {
					var engine=new HS();
					var m=new HS.Matcher();
					function tryEval(expression,force) {
						try {
							var result=engine.eval(expression);
							if(force) result.value();
							return result;
						} catch(e) {
							ok(false,'evaluation of '+SExpr.inspect(expression)+' should not error: msg='+e);
							throw 'aborted because unexpected error';
						}
					}
					function tryEvalType(expression) {
						try {
							return engine.evalType(expression);
						} catch(e) {
							ok(false,'type evaluation of '+SExpr.inspect(expression)+' should not error: msg='+e);
							throw 'aborted because unexpected error';
						}
					}
					for(var c=test_expressions; c!==null; c=c.cdr) {
						var s=c.car;
						if(m.match(s,'(t:=> _1 _2)')) { // assert
							var expression=m._[1];
							var expected=m._[2];
							var actual=tryEval(expression,true).value();
							var msg=SExpr.inspect(expression)+' => '+SExpr.inspect(expected);
							eq(expected,actual,msg);
						} else if(m.match(s,'(t:type=> _1 _2)')) {
							var expected=tryEvalType(m._[2]);
							var actual=tryEval(m._[1]).type;
							var msg='typeof '+SExpr.inspect(m._[1])+' should '+expected.inspect()+'. result: '+actual.inspect();
							ok(expected.isSameType(actual),msg);
						} else if(m.match(s,'(t:reset)')) {
							engine=new HS();
						} else if(m.match(s,'(t:should_error . _1)')) {
							var expression=m._[1];
							var thrown=undefined;
							try {
								engine.eval(expression);
							} catch(e) {
								thrown=e;
							}
							var msg=SExpr.inspect(expression)+' should throws exception';
							ok(thrown!==undefined,msg);
						} else {
							try {
								engine.eval(s);
							} catch(e) {
								ok(false,'evaluating '+SExpr.inspect(s)+' should not error: msg='+e);
								return;
							}
						}
					}
				});
			}
			$('script').each(function(i,script) {
				if(script.type!='text/hsjs-test') return;
				var data=$.ajax({type:'GET',async:false,url:script.src}).responseText;
				var parsed=new SParser().parse(data);
				var m=new HS.Matcher();
				for(var i=0;i<parsed.length;i++) {
					var s=parsed[i];
					if(!m.match(s,'(t:case _1 . _2)'))
						throw 'Test Syntax Error';
					var test_name=m._[1].isSymbol ? m._[1].name : m._[1];
					var test_expressions=m._[2];
					register_test(test_name,test_expressions);
				}
			 });
		 })();
	</script>
</head>
<body>
	<h1 id="qunit-header">HSJS Test Suite</h1>
	<h2 id="qunit-banner"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="qunit-fixture">test markup</div>
</body>
</html>
